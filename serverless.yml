service: cultural-pass-api

provider:
  name: aws
  region: ${opt:region, 'us-east-1'}
  stage: ${opt:stage, 'dev'}

# Variables personalizadas
custom:
  # IMPORTANTE: Actualiza esta URL con la URL de tu contenedor desplegado
  # Ejemplos:
  # - Railway: https://tu-app.railway.app
  # - Render: https://tu-app.onrender.com
  # - Koyeb: https://tu-app.koyeb.app
  # - ECS: http://tu-load-balancer.us-east-1.elb.amazonaws.com
  backendUrl: ${env:BACKEND_URL, 'http://localhost:8080'}

resources:
  Resources:
    # ==================== HTTP API (v2) - Soporta ANY method con HTTP_PROXY ====================
    HttpApi:
      Type: AWS::ApiGatewayV2::Api
      Properties:
        Name: ${self:service}-${self:provider.stage}
        Description: API Gateway HTTP API para Cultural Pass Backend
        ProtocolType: HTTP
        CorsConfiguration:
          AllowOrigins:
            - '*'
          AllowHeaders:
            - Content-Type
            - Authorization
            - X-Amz-Date
            - X-Api-Key
            - X-Amz-Security-Token
          AllowMethods:
            - GET
            - POST
            - PUT
            - DELETE
            - PATCH
            - OPTIONS
          MaxAge: 300
    
    # ==================== INTEGRATION ====================
    HttpApiIntegration:
      Type: AWS::ApiGatewayV2::Integration
      Properties:
        ApiId: !Ref HttpApi
        IntegrationType: HTTP_PROXY
        IntegrationUri: ${self:custom.backendUrl}/{proxy}
        IntegrationMethod: ANY
        PayloadFormatVersion: '1.0'
    
    # ==================== ROUTES ====================
    # Auth Routes
    AuthRoute:
      Type: AWS::ApiGatewayV2::Route
      Properties:
        ApiId: !Ref HttpApi
        RouteKey: 'ANY /api/auth/{proxy+}'
        Target: !Sub 'integrations/${HttpApiIntegration}'
    
    # Event Routes
    EventRoute:
      Type: AWS::ApiGatewayV2::Route
      Properties:
        ApiId: !Ref HttpApi
        RouteKey: 'ANY /api/event/{proxy+}'
        Target: !Sub 'integrations/${HttpApiIntegration}'
    
    # Token Routes
    TokenRoute:
      Type: AWS::ApiGatewayV2::Route
      Properties:
        ApiId: !Ref HttpApi
        RouteKey: 'ANY /api/token/{proxy+}'
        Target: !Sub 'integrations/${HttpApiIntegration}'
    
    # User Routes
    UserRoute:
      Type: AWS::ApiGatewayV2::Route
      Properties:
        ApiId: !Ref HttpApi
        RouteKey: 'ANY /api/user/{proxy+}'
        Target: !Sub 'integrations/${HttpApiIntegration}'
    
    # Statistics Routes
    StatisticsRoute:
      Type: AWS::ApiGatewayV2::Route
      Properties:
        ApiId: !Ref HttpApi
        RouteKey: 'ANY /api/statistics/{proxy+}'
        Target: !Sub 'integrations/${HttpApiIntegration}'
    
    # ==================== STAGE ====================
    HttpApiStage:
      Type: AWS::ApiGatewayV2::Stage
      Properties:
        ApiId: !Ref HttpApi
        StageName: ${self:provider.stage}
        Description: ${self:provider.stage} stage
        AutoDeploy: true
        DefaultRouteSettings:
          DetailedMetricsEnabled: true
          ThrottlingBurstLimit: 5000
          ThrottlingRateLimit: 10000
        AccessLogSettings:
          DestinationArn: !GetAtt ApiLogGroup.Arn
          Format: $context.requestId $context.error.message $context.error.messageString
    
    # ==================== CLOUDWATCH LOGS ====================
    ApiLogGroup:
      Type: AWS::Logs::LogGroup
      Properties:
        LogGroupName: /aws/apigateway/${self:service}-${self:provider.stage}
        RetentionInDays: 7

  # ==================== OUTPUTS ====================
  Outputs:
    HttpApiUrl:
      Description: URL del HTTP API Gateway
      Value: !Sub 'https://${HttpApi}.execute-api.${AWS::Region}.amazonaws.com/${self:provider.stage}'
      Export:
        Name: ${self:service}-${self:provider.stage}-api-url
    
    HttpApiId:
      Description: ID del HTTP API
      Value: !Ref HttpApi
      Export:
        Name: ${self:service}-${self:provider.stage}-http-api-id
